<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>An echo server</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Net</span> <span class="project-version">0.3.3-beta18</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="intro.html"><div class="inner"><span>Overview</span></div></a></li><li class="depth-1  current"><a href="echo.html"><div class="inner"><span>An echo server</span></div></a></li><li class="depth-1 "><a href="chat.html"><div class="inner"><span>A chat server</span></div></a></li><li class="depth-1 "><a href="tls.html"><div class="inner"><span>TLS support</span></div></a></li><li class="depth-1 "><a href="http-server.html"><div class="inner"><span>HTTP servers</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></div></li><li class="depth-3 branch"><a href="net.codec.b64.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>b64</span></div></a></li><li class="depth-3"><a href="net.codec.hex.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hex</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>core</span></div></div></li><li class="depth-3 branch"><a href="net.core.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3"><a href="net.core.concurrent.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>concurrent</span></div></a></li><li class="depth-2"><a href="net.http.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>http</span></div></a></li><li class="depth-3 branch"><a href="net.http.chunk.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>chunk</span></div></a></li><li class="depth-3 branch"><a href="net.http.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-3"><a href="net.http.server.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server</span></div></a></li><li class="depth-2 branch"><a href="net.ssl.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-2 branch"><a href="net.tcp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tcp</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>transform</span></div></div></li><li class="depth-3 branch"><a href="net.transform.aggregator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregator</span></div></a></li><li class="depth-3"><a href="net.transform.split.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>split</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>ty</span></div></div></li><li class="depth-3 branch"><a href="net.ty.bootstrap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bootstrap</span></div></a></li><li class="depth-3 branch"><a href="net.ty.buffer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buffer</span></div></a></li><li class="depth-3 branch"><a href="net.ty.channel.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>channel</span></div></a></li><li class="depth-3 branch"><a href="net.ty.coerce.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>coerce</span></div></a></li><li class="depth-3 branch"><a href="net.ty.future.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>future</span></div></a></li><li class="depth-3"><a href="net.ty.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#an-echo-server" name="an-echo-server"></a>An echo server</h1>
<p>Our first and simplest example is an echo server. Each incoming payload is repeated.</p>
<p>Our protocol will be simple and limited:</p>
<ul>
  <li>Connections are made to TCP port 1337.</li>
  <li>Messages are line delimited.</li>
  <li>Messages are played back</li>
</ul>
<p>To do this with net, we will create what’s called a Netty <em>ChannelAdapter</em>, which will sit at the bottom end of our input pipeline:</p>
<pre><code>+--------------------------+
|                          |
|  | line frame decoder    |
|  v                       |
+--------------------------+
|                          |
|  | string decoding       |
|  v                       |
+--------------------------+
|                        ^ |
|    string encoding     | |
|                          |
+--------------------------+
|                        ^ |
|    line frame encoder  | |
|                          |
+--------------------------+
|                          |
|    our chat handler      |
|                          |
+--------------------------+
</code></pre>
<p>This onion approach to adapters allows us to create a handler, knowing that payload will come as a well formed string.</p>
<p>We can start by creating our namespace:</p>
<pre><code class="clojure">(ns server.echo
  (:require [net.tcp         :as tcp]
            [net.ty.channel  :as channel]
            [net.ty.pipeline :as pipeline]))
</code></pre>
<p>Next we will create our echo pipeline:</p>
<pre><code class="clojure">(defn pipeline
  []
  (pipeline/channel-initializer
    [(pipeline/line-based-frame-decoder)
     pipeline/string-decoder
     pipeline/string-encoder
     pipeline/line-frame-encoder
     (pipeline/with-input [ctx msg]
       (channel/write-and-flush! ctx msg))]))
</code></pre>
<p>As you can see, our pipeline definition closely mimicks what we described above, and all steps of the pipeline but the last are provided for us:</p>
<ul>
  <li><a href="/net.ty.pipeline.html#var-line-based-frame-decoder"><code>pipeline/line-based-frame-decoder</code></a>  splits input by CRLF delimited frames.</li>
  <li><a href="/net.ty.pipeline.html#var-string-decoder"><code>pipeline/string-decoder</code></a>  transforms incoming byte frames into strings.</li>
  <li><a href="/net.ty.pipeline.html#var-string-decoder"><code>pipeline/string-encoder</code></a>  transforms outgoing strings to byte frames.</li>
  <li><a href="/net.ty.pipeline.html#var-line-frame-encoder"><code>pipeline/line-frame-encoder</code></a>  appends CRLF to outgoing strings.</li>
  <li><a href="/net.ty.pipeline.html#var-with-input"><code>pipeline/with-input</code></a> is a  facility to write custom handlers for input.</li>
</ul>
<p>The pipeline creation is wrapped in a call to <a href="/net.ty.pipeline.html#var-channel-initializer"><code>pipeline/channel-initializer</code></a>, to create a <a href="http://netty.io/4.1/api/io/netty/channel/ChannelInitializer.html"><strong>ChannelInitializer</strong></a> out of it. The role of initializers is to create an instance of the handling <em>finite state machine</em> for each incoming connection.</p>
<p>In our custom handler, we are given a <a href="http://netty.io/4.1/api/io/netty/channel/ChannelHandlerContext.html">ChannelHandlerContext</a> and the input message. The context is Netty’s representation of the connection and may be used to write to it (through <a href="/net.ty.channel.html#var-write.21"><code>channel/write!</code></a>, or <a href="/net.ty.channel.html#var-write-and-flush.21"><code>channel/write-and-flush!</code></a>).</p>
<p>Last, we can start our server:</p>
<pre><code class="clojure">(tcp/server {:handler (pipeline)} "localhost" 1337)
</code></pre>
<p>To test this example server, you may run <code>lein run -m server.echo</code> within the net project.</p></div></div></div></body></html>